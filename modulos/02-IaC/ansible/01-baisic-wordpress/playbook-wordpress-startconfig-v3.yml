---
  - hosts: database
    handlers:
      - name: restart mysql
        service:
          name: mysql
          state: restarted
        become: yes

    tasks:
      - name: "Instalando o MySQL"
        apt:
          name: "{{ item }}"
          state: latest
        become: yes
        with_items:
          - mysql-server-5.6 
          - python-mysqldb
      
      - name: "Criando o Banco de Dados"
        mysql_db:
          name: "{{ wp_db_name }}"
          login_user: root
          state: present
      
      - name: "Criando o usuario do MySQL"
        mysql_user:
          login_user: root
          name: "{{ wp_username }}"
          password: "{{ wp_db_passwd }}"
          priv: "{{ wp_db_name }}.*:ALL"
          state: present
          host: "{{ item }}"
        with_items:
          - 'localhost'
          - '127.0.0.1'
          - "{{ wp_host_ip }}"
        
      - name: "Configurando o MySQL"
        copy:
          src: "files/my.cnf"
          dest: "/etc/mysql/my.cnf"
        become: yes
        notify:
          - restart mysql

  - hosts: wordpress
    handlers:
      - name: restart apache
        service:
          name: apache2
          state: restarted
        become: yes
        
    tasks:
      - name: "Configurando o servidor de APP"
        apt:
          name: "{{ item }}"
          state: latest
        become: yes
        with_items:
          - php5
          - apache2
          - libapache2-mod-php5
          - php5-gd
          - libssh2-php
          - php5-mcrypt
          - php5-mysql

      - name: "Baixando os arquivois do Wordpress"
        get_url:
          url: "https://wordpress.org/latest.tar.gz"
          dest: "/tmp/latest.tar.gz"
      
      - name: "Descompactando os arquivos"
        unarchive:
          src: "/tmp/latest.tar.gz"
          dest: "/var/www/"
          remote_src: yes
        become: yes
      
      - name: "Copiando o wp-config.php"
        copy:
          src: "{{ root_dir }}/wp-config-sample.php"
          dest: "{{ root_dir }}/wp-config.php"
          remote_src: yes
        become: yes
      
      - name: "Editando o wp-config.php"
        ansible.builtin.replace:
          path: "{{ root_dir }}/wp-config-sample.php"
          regexp: "{{ item.regex }}"
          replace: "{{ item.value }}"
        with_items:
          - { regex: 'database_name_here', value: "{{ wp_db_name }}" }
          - { regex: 'username_here', value: "{{ wp_username }}" }
          - { regex: 'password_here', value: "{{ wp_db_passwd }}" }
          - { regex: 'localhost', value: "{{ db_host_ip }}" }
        become: yes
      
      - name: "Atualizando o vHost"
        template:
          src: "templates/000-default.conf.j2"
          dest: "/etc/apache2/sites-available/000-default.conf"
        become: yes
        notify:
          - restart apache